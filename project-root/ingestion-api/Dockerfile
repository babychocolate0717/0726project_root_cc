FROM python:3.10-slim 

WORKDIR /code

# å…ˆè¤‡è£½ requirements.txt åˆ©ç”¨ Docker å¿«å–
COPY requirements.txt .

# ä½¿ç”¨ --no-cache-dir æ¸›å°‘æ˜ åƒæª”å¤§å°
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt && \
    # æ¸…ç† pip å¿«å–
    rm -rf /root/.cache/pip

COPY ./app ./app

# è¨­å®šç’°å¢ƒè®Šæ•¸
ENV AUTH_SECRET_KEY=your-production-secret-key-2024
ENV COMPATIBILITY_MODE=true
ENV DEFAULT_ALLOWED_IPS=""
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# ğŸ†• æ–°å¢è¨­å‚™æŒ‡ç´‹ç›¸é—œç’°å¢ƒè®Šæ•¸
ENV FINGERPRINT_ENABLED=true
ENV FINGERPRINT_SIMILARITY_THRESHOLD=0.7
ENV HIGH_RISK_THRESHOLD=0.7
ENV MEDIUM_RISK_THRESHOLD=0.9

ENV WHITELIST_REQUIRED=false
# å»ºç«‹é root ä½¿ç”¨è€…ï¼ˆå®‰å…¨æ€§æœ€ä½³å¯¦è¸ï¼‰
RUN useradd --create-home --shell /bin/bash app
USER app

CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]